"use strict";const e=require("../../../common/vendor.js"),o=require("../../../local/index.js");require("../../../hooks/uni-hooks/new-dialog.js"),require("../../../store/modules/app.js");const n=require("../../../store/modules/device.js");require("../../../store/modules/order.js");const r=require("../../../store/modules/user.js"),t=require("../../../utils/common.js"),s=require("../../../utils/format.js"),u=require("../../../const/order.js"),a=require("../../../const/platform.js"),i=require("../../../const/emit.js");require("../../../utils/uniAsync.js");const d=require("../../../utils/validate.js");require("../../../utils/wx.log.js");const p=require("../../../utils/config/index.js"),c=require("../../../utils/aes.js"),l=require("../../../hooks/uni-hooks/dialog.js");require("../../../hooks/uni-hooks/request.js");const f=require("../../../hooks/uni-hooks/router.js"),h=require("../../../hooks/uni-hooks/unite.js"),m=require("../../../hooks/uni-hooks/wechat.js"),v=require("../../../hooks/useWechatSI.js"),y=require("../../../api/device.js"),_=require("../../../api/order.js"),w=require("../../../hooks/useCountryCode.js"),g=require("../../../hooks/use-mix.js");require("../../../shared/order.js");const j=require("../../../shared/pay.js"),k=require("../../../shared/user.js"),q=require("../../../shared/device.js"),P=require("../../../shared/coupon.js"),x=require("./hooks/use-coupon.js"),T=require("./hooks/use-privaty.js"),E=require("./hooks/use-delivery.js"),C=require("./hooks/use-exchange-coupon.js"),b=require("./hooks/use-reserve.js");if(require("../../../shared/cache.js"),require("../../../const/cache.js"),require("../../../hooks/uni-hooks/cache.js"),require("../../../utils/config/env.js"),require("../../../uni_modules/mot-utils/index.js"),require("../../../theme/hooks/useTheme.js"),require("../../../theme/hooks/themeConfig.js"),require("../../../theme/hooks/themeKeys.js"),require("../../../api/user.js"),require("../../../hooks/usePromise.js"),require("../../../api/delivery.js"),require("../../../utils/appEnterVerif.js"),require("../../../hooks/use-common.js"),require("../../../hooks/uni-hooks/loading.js"),require("../../../hooks/uni-hooks/common.js"),require("../../../utils/url.js"),require("../../../hooks/uni-hooks/report.js"),require("../../../api/data.js"),require("../../../utils/precision.js"),require("../../../hooks/use-keyval/index.js"),require("../../../const/coupon.js"),require("../../../utils/is.js"),require("../../../const/common.js"),require("../../../const/site.js"),require("../../../api/coupon.js"),require("../../../hooks/business/use-exchange-coupon.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("mot-modal"))()}Math||(I+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+R+D+(()=>"../../../node-modules/@dcloudio/uni-ui/lib/uni-data-checkbox/uni-data-checkbox.js")+U+L+F+(()=>"../../../uni_modules/mot-modal/components/mot-modal/mot-modal.js")+O)();const I=()=>"../../../components/mot-site/index.js",R=()=>"./components/deposit-ways.js",D=()=>"../../../components/business/phone-button/index.js",L=()=>"../../../components/v1/coupon/coupon-popup.js",F=()=>"../../../components/v1/coupon/coupon-exchange-popup.js",O=()=>"../../../components/v1/coupon/exchange-success-popup.js",U=()=>"../../../components/v1/pay-popup/index.js",A=e.defineComponent({__name:"index",setup(I){const R=()=>{f.navigateTo(`/sub-pages/common/country-code/index?country=${O.form.country}&from=deposit`)},{autoPlay:D}=v.useWechatSI(),L=n.useDeviceStore(),F=r.useUserStore(),O=e.reactive({payRule:{},freeLocker:{},site:L.site||{},cabinet:L.cabinet||{},showPay:!1,loading:!1,form:{phone:d.t344Phone(F.phone||""),password:"",country:F.user.login_country||L.country||""},payed:0,total_payed:0,useCoupon:!1,depositType:u.DepositTypeEnum.PhonePassword,Idcard:!1,face:{faceUrl:"",faceId:""},idInfo:{real_name:"",id_card:""}}),{countryList:U,setCountryList:A}=w.useCountryCode(),S=e.ref([]),M=e.computed((()=>t.getNeedValue(O.form.country,"code","tel",S.value))),$=e.computed((()=>{const{deposit:e,prepaid:o}=O.payRule;return(e||0)+o})),V=e.computed((()=>{var e;return(null==(e=F.orderOpt)?void 0:e.rental_period)===u.RentalPeriodEnum.SHORT_RENTAL&&(L.cabinet.max_unlock_count||0)})),{showCoupon:B,currentCoupon:H,openCouponPopup:N,showCouponPopup:K,setCouponList:z,couponList:J}=x.useConpon(),{isFromReserve:W}=b.useReserve(),Y=async e=>{await z(e),ke()},G=e.ref({}),Q=({coupon:e,type:o})=>{if("exchange"===o)fe.value=!0,G.value=e;else{const{coupons:o}=e;Y(o[0])}},X=e.computed((()=>P.showCouponText({coupon:H.value,payRule:O.payRule}))),Z=e.computed((()=>{const{showPhone:e,showPwdItem:o,showFaceItem:n}=ee.value;return n||o||e||ae.value})),ee=e.computed((()=>{const{fetch_types:e,require_phone:o}=L.site,n=u.FetchTypeEnumMap[O.depositType],r=e.includes("face")&&e.includes("phone_pass");return{showPhone:(null==o?void 0:o.includes(n))||O.depositType===u.DepositTypeEnum.PhonePassword,showPassFace:r,showPwdItem:O.depositType===u.DepositTypeEnum.PhonePassword,showFaceItem:O.depositType===u.DepositTypeEnum.FaceId||O.depositType===u.DepositTypeEnum.FacePad}})),oe=e.computed((()=>O.depositType===u.DepositTypeEnum.FacePad)),{isShowAgree:ne,privateHtml:re,showAgreeModal:te,onAgree:se,checkAgree:ue}=T.usePrivaty(),{isFromDelivery:ae,DeliveryOrderResult:ie,openEmbeddedMiniProgramDelivery:de}=E.useDelivery(),{showExchangePopup:pe,openExchangePopup:ce,showExchageCoupon:le,showSuccessPopup:fe,activeTab:he,checkHasCoupon:me}=C.useExchangeConpon();e.onLoad((async()=>{L.defaultFetchType&&(O.depositType=L.defaultFetchType),O.site.force_select_locker_enable||q.isOneCodOneCabinet()?O.freeLocker=L.freeLocker:O.freeLocker=await qe(),ye()})),ae.value?e.onShow((()=>{xe.value&&ie(xe.value)})):e.onLoad((async e=>{await je(),await z(),ke(),L.defaultFetchType?O.depositType!==u.DepositTypeEnum.IdCard&&O.depositType!==u.DepositTypeEnum.FacePad||we(O.depositType):l.showModal({content:o.t("pages.v1.index.index.22")}).finally(f.goHome)})),e.onShow((()=>{m.envEvent.report.addPage({page_name:"a_page_deposit_view"}),h.unite.setNavigationBarTitle(o.t("v1_deposit.title")),e.index.$once(i.EMIT_FACE_UPLOAD_SUCCESS,(e=>{O.face=e})),e.index.$once(i.EMIT_ID_CARD_SUCCESS,(e=>{O.Idcard=e})),O.showPay=!1,O.loading=!1,e.index.$once(i.EMIT_UPDATE_FREE_LOCKER,(({freeLocker:e})=>{O.freeLocker=e})),e.index.$once(i.EMIT_UPDATE_DEPOSIT_AREACODE,(e=>{O.form.country=e}))})),e.watch((()=>O.form.phone),((e,o)=>{e&&o&&(O.form.phone=e.length>o.length?d.t344Phone(e):O.form.phone.trim())})),e.watch((()=>O.form.password),((o,n)=>{4===o.length&&e.index.hideKeyboard()}));const ve={10579:o.t("sub-pages.order.deposit.index.48"),10580:o.t("sub-pages.order.deposit.index.49"),10583:o.t("sub-pages.order.deposit.index.52"),10584:o.t("sub-pages.order.deposit.index.53")},ye=async()=>{(ee.value.showPhone||ae)&&(U.value.length||await A(),_e())},_e=()=>{S.value=U.value.map((e=>({...e,text:`${e.name}-${e.enName} (${e.tel})`,value:e.code,show:!0})))},we=e=>{y.deviceApi.face({cabinet_id:L.cabinetId,fetch_type:e},!1).then((o=>{let{face_url:n,face_id:r,id_card:t,real_name:s,face_data:a}=o,i={};e===u.DepositTypeEnum.IdCard&&t&&(i={id_card:c.aesDecrypt(t),real_name:c.aesDecrypt(s)},L.updateIdState(i),F.setOrderOpt({id_card:t,real_name:s})),e===u.DepositTypeEnum.FacePad&&n&&(O.face.faceUrl=n,O.face.faceId=r,F.setOrderOpt({face_url:n,face_id:r}),L.updateFaceState({face_data:a}))})).catch((e=>{const{ErrCode:o}=e;l.dialog.showModal({content:ve[o],showCancel:!1}).then(f.goHome)}))},ge=F.orderOpt,je=async()=>{const e=L.siteId;try{const n=await y.deviceApi.payRule(e,ge.locker_type,ge.rental_period);if(!n)return void l.dialog.alert(o.t("sub-pages.order.deposit.index.25")).then(f.goHome);O.payRule=n,L.setPayRule(n)}catch(n){throw console.log(n,"fetchApi:error"),new Error(JSON.stringify(n))}},ke=async()=>{const{payRule:e,site:o}=O,n={site_id:o.id,pay_rule_id:e.id},r={...H.value};P.canUseCoupon(r,e)&&(n.coupon_id=r.id);const{payed:t,total_payed:s}=await _.paymentApi.payed(n);O.payed=t,O.total_payed=s},qe=async()=>{const{freeLocker:e}=O;return L.assignLocker(L.cabinet.id,ge.locker_type,e.id,e.touch_at)},Pe=()=>{m.envEvent.report.addPage({page_name:"a_page_change_locker_view"})},xe=e.ref(""),Te=async()=>{try{const e=await Ee();await Ce(e)}catch(e){O.loading=!1}},Ee=async()=>{const e=await qe();if(O.freeLocker.id!==e.id){const n=`${o.t("v1.deposit.index.3")}${s.fullLockerName(e.name,O.cabinet.address)}${o.t("v1.deposit.index.5")}`;await l.dialog.showModal({content:n})}O.freeLocker=e,L.setFreeLocker(e);const n=be();return F.setOrderOpt({...n}),n},Ce=async e=>{const{site:o,payed:n}=O;let r="";if(n>0){const{display_id:t}=await j.topUp({payed:n,site_id:o.id,order_data:e});r=t}Ie(r,n)},be=()=>{const{freeLocker:e,site:o,payRule:n}=O,r={...H.value},t=F.orderOpt,s={locker_id:e.id,pay_rule_id:n.id,site_id:o.id,coupon_id:"",fetch_type:u.DepositTypeEnum.PhonePassword,pre_create:!1};s.fetch_type=O.depositType,W.value&&(s.pre_create=!0);const{showPhone:a,showPwdItem:i,showFaceItem:p}=ee.value;p&&(s.face_id=t.face_id,s.face_url=t.face_url),i&&(s.password=d.trim(O.form.password)),a&&(s.area_code=M.value||"+86",s.phone=d.trim(O.form.phone)),s.fetch_type===u.DepositTypeEnum.IdCard&&(s.id_card=t.id_card,s.real_name=t.real_name);return P.canUseCoupon(r,n)&&(s.coupon_id=r.id),s},Ie=(e,o)=>{let n=`/pages/order/open/index?from=${W.value?u.OrderResultEnum.RESERVE:u.OrderResultEnum.CREATE}`;e&&(n+=`&displayId=${e}`),o&&(n+=`&payed=${o}`),f.reLaunch(n),O.loading=!1},Re=({code:e,type:o})=>{De({code:e,type:o||a.PlatformEnum,area_code:M.value||"+86"})},De=async e=>{const o=await k.setPhone(e);O.form.phone=d.t344Phone(o),F.setUserInfo({...F.user,phone:o})},Le=()=>{f.navigateTo("/sub-pages/v1/face/index")},Fe=e.ref();return(n,r)=>{var t,a,i,c,h,v,y,w,j,k,P,x,T,E,C,b,I,U,A;return e.e({a:"overflow:"+(e.unref(ne)||e.unref(K)||e.unref(pe)||e.unref(fe)?"hidden":"visible"),b:e.t(e.unref(o.t)("v1_deposit.no")),c:e.t(e.unref(s.fullLockerName)(e.unref(O).freeLocker.name,e.unref(O).cabinet.address)),d:!e.unref(q.isOneCodOneCabinet)()},e.unref(q.isOneCodOneCabinet)()?{}:{e:e.t(e.unref(o.t)("v1_deposit.change")),f:e.p({type:"right",size:"10",color:"#5B6B92"}),g:e.o(Pe)},{h:e.unref(Z)},e.unref(Z)?e.e({i:e.t(e.unref(o.t)("v1_deposit.voucher")),j:(null==(t=e.unref(ee))?void 0:t.showPassFace)&&!e.unref(ae)},(null==(a=e.unref(ee))?void 0:a.showPassFace)&&!e.unref(ae)?{k:e.o((o=>e.unref(O).depositType=o)),l:e.p({modelValue:e.unref(O).depositType})}:{},{m:(null==(i=e.unref(ee))?void 0:i.showPhone)||e.unref(ae)},(null==(c=e.unref(ee))?void 0:c.showPhone)||e.unref(ae)?e.e({n:e.unref(p.config).fileBaseUrl+"/icon/icon_phone.png",o:e.t(e.unref(o.t)("v1_deposit.input_phone")),p:(null==(h=e.unref(L))?void 0:h.country)&&e.unref(S)&&e.unref(S).length},(null==(v=e.unref(L))?void 0:v.country)&&e.unref(S)&&e.unref(S).length?{q:e.t(e.unref(M)),r:e.o(R)}:{},{s:e.unref(O).form.phone?1:"",t:e.unref(o.t)("v1_deposit.input_phon_placeholder"),v:e.unref(O).form.phone,w:e.o((o=>e.unref(O).form.phone=o.detail.value)),x:null==(w=null==(y=e.unref(L))?void 0:y.shop)?void 0:w.auto_get_phone_enable},(null==(k=null==(j=e.unref(L))?void 0:j.shop)?void 0:k.auto_get_phone_enable)?{y:e.o(Re)}:{}):{},{z:(null==(P=e.unref(ee))?void 0:P.showPwdItem)&&!e.unref(ae)},(null==(x=e.unref(ee))?void 0:x.showPwdItem)&&!e.unref(ae)?{A:e.unref(p.config).fileBaseUrl+"/icon/icon_lock.png",B:e.t(e.unref(o.t)("v1_deposit.input_password")),C:e.unref(O).form.password?1:"",D:e.unref(o.t)("v1_deposit.input_password_placeholder"),E:e.unref(O).form.password,F:e.o((o=>e.unref(O).form.password=o.detail.value))}:{},{G:(null==(T=e.unref(ee))?void 0:T.showFaceItem)&&!e.unref(ae)},(null==(E=e.unref(ee))?void 0:E.showFaceItem)&&!e.unref(ae)?e.e({H:e.unref(p.config).fileBaseUrl+"/icon/icon_user.png",I:e.t(e.unref(o.t)("v1_deposit.input_face_placeholder")),J:e.unref(O).face.faceUrl},e.unref(O).face.faceUrl?{K:e.unref(O).face.faceUrl}:{},{L:!e.unref(oe)},e.unref(oe)?{}:{M:e.t(e.unref(o.t)("v1_deposit.button_upload")),N:e.o(Le)}):{}):{},{O:e.unref(O).payRule.title},e.unref(O).payRule.title?e.e({P:e.t(e.unref(o.t)("v1_deposit.rule_title")),Q:e.t(e.unref(O).payRule.title),R:e.unref(V)},e.unref(V)?e.e({S:e.unref(V)===e.unref(u.UnLockerCountEnums).Unrestricted},e.unref(V)===e.unref(u.UnLockerCountEnums).Unrestricted?{T:e.t(e.unref(o.t)("shared.order.7"))}:{U:e.t(e.unref(o.t)("sub-pages.order.deposit.index.42")),V:e.t(e.unref(V)),W:e.t(e.unref(o.t)("shared.order.6"))}):{}):{},{X:e.unref(le)},e.unref(le)?{Y:e.t(e.unref(o.t)("coupon.exchange_card")),Z:e.t(e.unref(o.t)("coupon.exchange")),aa:e.o((o=>e.unref(ce)()))}:{},{ab:e.unref(B)&&e.unref(J).length},e.unref(B)&&e.unref(J).length?{ac:e.t(e.unref(o.t)("components.v1.coupon.coupon-panel.1")),ad:e.t((null==(C=e.unref(H))?void 0:C.name)||e.unref(o.t)("v1.deposit.index.4")),ae:e.o((o=>e.unref(N)()))}:{},{af:e.o((o=>e.isRef(ue)?ue.value=o:null)),ag:e.p({multiple:!0,localdata:[{text:e.unref(o.t)("v1_deposit.agreement"),value:1}],modelValue:e.unref(ue)}),ah:e.t(e.unref(o.t)("v1_deposit.protocol")),ai:e.o((o=>e.unref(te)())),aj:e.t(e.unref(W)?e.unref(o.t)("sub-pages.common.pay-center.index.14"):e.unref(o.t)("v1_deposit.payment")),ak:e.t(e.unref(g.useToYuan)(e.unref($))),al:null==(b=e.unref(H))?void 0:b.id},(null==(I=e.unref(H))?void 0:I.id)?{am:e.t(e.unref(X))}:{},{an:e.t(e.unref(o.t)("v1_deposit.button_payment")),ao:e.o((n=>e.unref(ae)?(async()=>{if(L.country&&S.value&&S.value.length?!d.isRegCode(O.form.phone,O.form.country,S.value,"phone"):!d.isInternationalPhone(O.form.phone))return void l.toast(o.t("v1_deposit.toast.phone"));const e=await Ee(),{site:n}=O,r=await _.orderApi.postPreOrders(1,n.id,e,u.PreOrderTypeEnum.DELIVERY,"express");xe.value=r.display_id,de(r.display_id)})():(async()=>{if(await me())return;const e=F.orderOpt;m.envEvent.report.addClick("a_page_deposit_clk");const{showPhone:n,showPwdItem:r,showFaceItem:t}=ee.value;if(n&&(L.country&&S.value&&S.value.length?!d.isRegCode(O.form.phone,O.form.country,S.value,"phone"):!d.isInternationalPhone(O.form.phone)))return void l.toast(o.t("v1_deposit.toast.phone"));if(t&&!O.face.faceUrl&&!O.face.faceId)return void l.toast(o.t("v1_deposit.toast.face"));if(!(O.depositType!==u.DepositTypeEnum.IdCard||e.id_card&&e.real_name))return void l.toast(o.t("sub-pages.order.deposit.index.51"));if(r&&!d.validPassword(O.form.password))return void l.toast(o.t("v1_deposit.toast.password"));1===ue.value[0]?!L.site.identity_enable||O.Idcard?(O.showPay=!0,D(o.t("sub-pages.order.deposit.index.40"))):f.navigateTo("/sub-pages/single/get-id/index?fetch_type="+O.depositType):l.toast(o.t("v1_deposit.toast.agreement"))})())),ap:e.o(Te),aq:e.o((o=>e.unref(O).showPay=o)),ar:e.o((o=>e.unref(O).loading=o)),as:e.p({"order-data":{...e.unref(O).form,...e.unref(O).face,depositType:e.unref(O).depositType,payed:e.unref(O).payed,payRule:e.unref(O).payRule,coupon:e.unref(H)},showFaceItem:null==(U=e.unref(ee))?void 0:U.showFaceItem,showPwdItem:null==(A=e.unref(ee))?void 0:A.showPwdItem,modelValue:e.unref(O).showPay,loading:e.unref(O).loading}),at:e.o(ke),av:e.o((o=>e.isRef(K)?K.value=o:null)),aw:e.o((o=>e.isRef(H)?H.value=o:null)),ax:e.p({coupons:e.unref(J),visible:e.unref(K),modelValue:e.unref(H)}),ay:e.o(Q),az:e.o((o=>e.isRef(pe)?pe.value=o:null)),aA:e.p({activeTab:e.unref(he),visible:e.unref(pe)}),aB:e.unref(re),aC:e.o(e.unref(se)),aD:e.o((o=>e.isRef(ne)?ne.value=o:null)),aE:e.p({cancelStyle:"text",title:e.unref(o.t)("sub-pages.order.deposit.index.20"),cancelText:e.unref(o.t)("button.cancel"),confirmText:e.unref(o.t)("sub-pages.order.deposit.index.41"),modelValue:e.unref(ne)}),aF:e.o(Y),aG:e.o((o=>e.isRef(fe)?fe.value=o:null)),aH:e.p({item:e.unref(G),modelValue:e.unref(fe)}),aI:e.sr(Fe,"a75e3b3c-10",{k:"ModalRef"}),aJ:e.p({id:"ModalRef"})})}}}),S=e._export_sfc(A,[["__scopeId","data-v-a75e3b3c"]]);wx.createPage(S);
