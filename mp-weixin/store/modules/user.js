"use strict";const e=require("../../common/vendor.js");require("../../local/index.js"),require("../../hooks/uni-hooks/new-dialog.js"),require("./app.js"),require("./device.js"),require("./order.js"),require("../../utils/uniAsync.js"),require("../../utils/wx.log.js");const s=require("../../utils/config/index.js"),o=require("../../utils/appEnterVerif.js");require("../../hooks/uni-hooks/dialog.js"),require("../../hooks/uni-hooks/request.js");const t=require("../../hooks/uni-hooks/wechat.js");require("../../hooks/useCountryCode.js");const i=require("../../api/user.js"),n=require("../../shared/cache.js"),r=e.defineStore({id:"USER",state:()=>({token:"",orderOpt:{locker_type:1},jdOrderOpt:{},sceneInfo:{},user:n.getUserStorage()||{},language:n.getLanguageStorage()||"zh",coupon:{},vipCoupon:{},askMetro:!1}),getters:{userId:e=>e.user.id,userName:e=>e.user.nickname,phone:e=>e.user.phone,balance:e=>e.user.balance,follow:e=>e.user.follow,id:e=>e.sceneInfo.id,page:e=>e.sceneInfo.page,noMpAccount:e=>1===e.user.type},actions:{setAccessToken(e){return this.token=e,n.setTokenStorage(e)},setUserInfo(e){const s=Object.assign(this.user,e);this.user=s,t.envEvent.report.addGlobal({user_phone:this.user.phone,user_name:this.user.nickname}),n.setUserStorage({...s})},setSceneInfo(e,s=!0){(null==e?void 0:e.fetch_type)&&(e.fetch_type=Number(e.fetch_type)),this.sceneInfo=s?e:{...this.sceneInfo,...e}},setOrderOpt(e={}){this.orderOpt={...this.orderOpt,...e}},setJdOrderOpt(e={},s=!1){this.jdOrderOpt=s?e:{...this.jdOrderOpt,...e}},setCoupon(e){this.coupon={...e}},setVipCoupon(e){this.vipCoupon=e},async login(e){return this.wxLogin(e)},async html5Login(e){const s=this;return!(!o.checkAppEnterVerif("app/metro")||n.getTokenStorage()||s.askMetro)&&await s.metroLogin(e)},async metroLogin(e){return new Promise((async(o,t)=>{let n=this,r="";n.askMetro=!0;try{const{social_id:t}=this.sceneInfo;await(null==AlipayJSBridge?void 0:AlipayJSBridge.call("metro_thirdPartyAuthToken",{thirdCode:"xiaoTie",authCodeList:["metroUserId","mobile"]},(async function(a){var c;console.log("result:",a);const u=null==a?void 0:a.code;if(2e3===u)o("");else if(1e3===u){const{access_token:u,user_id:d}=await i.userApi.metroLogin({token:null==(c=null==a?void 0:a.data)?void 0:c.token,scene:e,social_id:t||s.config.appId});r=d,await n.setAccessToken(u),o(r||"")}n.askMetro=!1})))}catch(a){console.log("调用AlipayJSBridge授权失败："+(null==a?void 0:a.msg)),o("")}}))},async wxLogin(e){const o=await t.envEvent.login(),{access_token:n,user_id:r}=await i.userApi.wechatLogin({code:o,scene:e,app_id:s.config.appId});return await this.setAccessToken(n),r},async alipayLogin(e){var o;const n=await(null==(o=t.envEvent)?void 0:o.getAuthCode()),{access_token:r,user_id:a}=await i.userApi.alipayLogin({code:n,scene:e,app_id:s.config.appId});return await this.setAccessToken(r),a},async h5Login(e,o,t={}){const n=o+"h5",{social_id:r}=this.sceneInfo,{access_token:a,user_id:c}=await i.userApi.h5Login({code:n,scene:e||"",social_id:r||s.config.appId,...t});return await this.setAccessToken(a),c},async fetchUser(){const e=await i.userApi.get();return this.setUserInfo(e),e},async updateUser(e,s){const o=await i.userApi.put(e,s);return this.setUserInfo(o),o}}});exports.useUserStore=r;
