"use strict";const e=require("../../api/device.js"),t=require("../../api/order.js"),s=require("../../api/user.js"),r=require("../../common/vendor.js"),o=require("../../local/index.js"),i=require("../../hooks/uni-hooks/new-dialog.js");require("./app.js"),require("./order.js");const n=require("./user.js"),a=require("../../const/order.js");require("../../utils/uniAsync.js"),require("../../utils/wx.log.js"),require("../../utils/config/index.js");const c=require("../../hooks/uni-hooks/dialog.js");require("../../hooks/uni-hooks/request.js");const d=require("../../hooks/uni-hooks/router.js"),u=require("../../hooks/uni-hooks/wechat.js"),l=require("../../hooks/usePromise.js");require("../../hooks/useCountryCode.js");const p=require("../../api/delivery.js"),h=require("../../shared/cache.js"),g=require("../../shared/device.js"),_=r.defineStore({id:"DEVICE",state:()=>({freeLocker:{},payRule:{},face:{},cabinet:h.getCabinetStorage()||{},lockers:h.getLockersStorage()||[],shop:h.getShopStorage()||{},site:h.getSiteStorage()||{},ad:h.getAdStorage()||{},IdInfo:{}}),getters:{locker_types:e=>{const{locker_types:t}=e.cabinet;return t&&0!==t.length?t:[1]},lockerTypesEnable:e=>g.lockerTypesEnable(e.cabinet.locker_types),locker_count_map:e=>e.cabinet.locker_count_map,rentalPeriodMap:e=>e.cabinet.rental_period_map,payRules:e=>e.site.pay_rules,shopId:e=>e.shop.id,siteId:e=>e.site.id,siteName:e=>e.site.name,cabinetId:e=>e.cabinet.id,vipType:e=>e.shop.vip_type,vipCouponEnable:e=>e.shop.vip_coupon_enable,couponEnable:e=>e.shop.coupon_enable,useBalanceEnable:e=>e.shop.use_balance_enable,faceBase64Url:e=>e.face.face_data,lockerTypeText:e=>e.site.locker_type_text,defaultFetchType:e=>{const{fetch_types:t}=e.site,s=n.useUserStore(),{fetch_type:r}=s.sceneInfo;return t&&0!==t.length?t.includes("pad_face")||t.includes("pad_id_card")?r||!1:t.includes("phone_pass")?a.DepositTypeEnum.PhonePassword:t.includes("face")?a.DepositTypeEnum.FaceId:a.DepositTypeEnum.PickCode:a.DepositTypeEnum.PickCode},country:e=>{const{country:t}=e.shop;return t||""}},actions:{updateFaceState(e){this.face=e},updateIdState(e){this.IdInfo=e},updateState({cabinet:e,lockers:t,shop:s,site:r,ad:o}){this.shop=s,this.site=r,this.cabinet=e,this.lockers=t,this.ad=o,h.setCabinetStorage(e),h.setLockersStorage(t),h.setShopStorage(s),h.setSiteStorage(r),h.setAdStorage(o)},clearState(){this.payRule={},this.freeLocker={},this.shop={},this.site={},this.cabinet={},this.lockers={},h.removeCabinetStorage(),h.removeShopStorage(),h.removeSiteStorage(),h.removeLockersStorage()},setFreeLocker(e){this.freeLocker={...e}},setPayRule(e){this.payRule={...e}},async fetchCabinet(t,r){var o;const n=await e.deviceApi.cabinet({scene:t.id,locker_scene:t.locker_scene,is_create_order:!r}),{cabinet:a,lockers:c,shop:d,site:l}=n,p=await s.userApi.getSiteAd(l.id);this.freeLocker={},t.locker_scene&&(a.locker_scene=t.locker_scene,c.length&&this.setFreeLocker(c[0]));const{passed:h,message:_}=g.checkValidCabinet(a,l,d,{isopen:r});return h?(this.updateState({cabinet:a,lockers:c,shop:d,site:l,ad:p}),r||u.envEvent.report.addGlobal({site_name:(null==this?void 0:this.siteName)||"",site_id:(null==this?void 0:this.siteId)||"",shop_id:(null==this?void 0:this.shopId)||"",shop_name:(null==(o=null==this?void 0:this.shop)?void 0:o.name)||"",locker_id:(null==this?void 0:this.cabinetId)||""}),n):(i.alert(_),Promise.reject({message:_}))},async assignLocker(e,t,s,r,n=""){const[a,p]=await l.usePromise(this.fetchFreeLocker(e,t,s,r,n));if(a){let{ErrCode:e=5001,ErrMsg:t=o.t("sub-pages.order.deposit.index.37")}=a||{};return t=10506===e?o.t("sub-pages.order.deposit.index.43"):`${t}(${e})`,i.alert(`${t}`).then((()=>{10506===e&&(u.envEvent.report.addPage({page_name:"a_page_device_nearby_view",full_cabinet_entrance_type:"order"}),d.navigateTo(`/sub-pages/common/device-nearby/index?scene=${n}`))})),Promise.reject(a)}return p||(c.dialog.showModal({content:o.t("sub-pages.order.deposit.index.38")}).then(d.goHome),Promise.reject({code:5001,message:o.t("sub-pages.order.deposit.index.38")}))},async fetchFreeLocker(t,s,r,o,i=""){const n=await e.deviceApi.locker(t,s,r,o,!1,i);return this.setFreeLocker(n),n},async open(e,s,r={},n=null){const{catchError:c=!0,homePage:u=!0,ignore1705:l=!1}=r,{id:h}=this.cabinet;s.open_cabinet_id=h;try{return[a.OrderResultEnum.JDCREATE,a.OrderResultEnum.JDCANCEL].includes(n)?await p.DeliveryApi.logisticOrderOpen(e,s):await t.lockerOrderApi.open(e,s)}catch(g){let{ErrCode:t=5001,ErrMsg:r=o.t("modules.device.1")}=g||{};if(!l&&(1705===t||1601===t)){const r=(null==s?void 0:s.end)?a.OrderResultEnum.DONE:a.OrderResultEnum.UNLOCK;throw this.doorStuck(r,e,t),g}throw c&&i.alert(`${r}(${t})`).then((()=>{u&&([a.OrderResultEnum.JDCREATE,a.OrderResultEnum.JDCANCEL].includes(n)?d.reLaunch("/sub-pages/v2/xd/home/index"):d.goHome())})),g}},doorStuck(e,t,s){const r=`${e}&orderId=${t}&code=${s}`;d.navigateTo(`/sub-pages/order/exception/mqtt/index?from=${r}`)},jumpFollow:(e,t)=>e&&!t,hasFreeCabinet(e){const{locker_types:t,free_locker_count:s,locker_count_map:r}=e;if(g.lockerTypesEnable(t))return s>0;return r[g.defaultLockerType(t)]>0},async getNextPage(e=1,t){const s=n.useUserStore(),{locker_types:r,rental_period_map:o}=this.cabinet||{},{vip_coupon_enable:i,vip_type:a}=this.shop||{},{force_select_locker_enable:c}=this.site||{},{follow_enable:d}=this.site||{},{inOfficialScene:u}=s.sceneInfo;if(this.jumpFollow(d,s.follow)&&e<=1&&t.follow)return`/sub-pages/common/${u?"follow":"scene"}/index`;if(i&&e<=1)return a.startsWith("mixc")?"/sub-pages/common/authorize/index":"/sub-pages/common/phone/index";if(e<=2&&g.hasLongShortRentalPeriod(o))return"/pages/v1/device-type/index";if(e<=2){const e=g.defaultLockerType(r),t=g.defaultRentalPeriod(o,e);s.setOrderOpt({locker_type:e,rental_period:t})}return e<=2&&g.lockerTypesEnable(r)&&!g.isOneCodOneCabinet()?"/pages/v1/device-type/index":c&&!g.isOneCodOneCabinet()?"/sub-pages/order/locker/index":"/pages/v1/deposit/index"},async goNextPage(e=1,t={nearby:!0,routeway:d.navigateTo,follow:!0}){if(!this.hasFreeCabinet(this.cabinet)&&t.nearby)return u.envEvent.report.addPage({page_name:"a_page_device_nearby_view",full_cabinet_entrance_type:"scan"}),void d.redirectTo("/sub-pages/common/device-nearby/index");const s=await this.getNextPage(e,t);t.routeway(s)},getuserIdentity:async()=>await s.userApi.getiIdentity()}});exports.useDeviceStore=_,exports.useDeviceStoreRefs=()=>r.storeToRefs(_());
