"use strict";const e=require("../../../common/vendor.js"),o=require("../../../local/index.js");require("../../../hooks/uni-hooks/new-dialog.js"),require("../../../store/modules/app.js");const n=require("../../../store/modules/device.js");require("../../../store/modules/order.js");const u=require("../../../store/modules/user.js"),i=require("../../../const/site.js"),s=require("../../../const/coupon.js");require("../../../utils/uniAsync.js"),require("../../../utils/wx.log.js");const r=require("../../../utils/config/index.js"),p=require("../../../hooks/uni-hooks/dialog.js");require("../../../hooks/uni-hooks/request.js"),require("../../../hooks/uni-hooks/wechat.js"),require("../../../hooks/useCountryCode.js");const t=require("../../../api/coupon.js"),c=require("../../../hooks/business/use-exchange-coupon.js");if(require("../../../hooks/uni-hooks/unite.js"),require("../../../const/platform.js"),require("../../../shared/cache.js"),require("../../../const/cache.js"),require("../../../hooks/uni-hooks/cache.js"),require("../../../utils/config/env.js"),require("../../../uni_modules/mot-utils/index.js"),require("../../../theme/hooks/useTheme.js"),require("../../../theme/hooks/themeConfig.js"),require("../../../theme/hooks/themeKeys.js"),require("../../../api/device.js"),require("../../../api/order.js"),require("../../../api/user.js"),require("../../../const/order.js"),require("../../../hooks/uni-hooks/router.js"),require("../../../hooks/usePromise.js"),require("../../../api/delivery.js"),require("../../../shared/device.js"),require("../../../const/common.js"),require("../../../utils/appEnterVerif.js"),require("../../../hooks/use-common.js"),require("../../../hooks/uni-hooks/loading.js"),require("../../../hooks/uni-hooks/common.js"),require("../../../utils/url.js"),require("../../../hooks/uni-hooks/report.js"),require("../../../api/data.js"),!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("mot-empty")+e.resolveComponent("mot-button")+e.resolveComponent("uni-popup"))()}Math||(l+v+a+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../uni_modules/mot-empty/components/mot-empty/mot-empty.js")+d+(()=>"../../../uni_modules/mot-button/components/mot-button/mot-button.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a=()=>"./coupon-list-item.js",l=()=>"../../popup-header/index.js",v=()=>"../../tab-panel/index.js",d=()=>"../../input/index.js",m=e.defineComponent({__name:"coupon-exchange-popup",props:{visible:{type:Boolean,default:!1},activeTab:{type:String,default:""}},emits:["confirm","update:visible"],setup(a,{emit:l}){const v=a,d=n.useDeviceStore(),m=u.useUserStore(),{code:h,onScan:f}=c.useExchangeCouponGlobal(),b=e.ref(),j=e.ref(o.t("components.v1.coupon.vip-coupon-panel.1")),q=[{name:o.t("components.v1.coupon.vip-coupon-panel.1"),value:s.CouponActiveTabEnum.VIP,desc:o.t("components.v1.coupon.vip-coupon-popup.16"),show:()=>d.shop.vip_coupon_enable&&y.value.length},{name:o.t("coupon.exchange_card"),value:s.CouponActiveTabEnum.EXCHANGE,desc:o.t("coupon.exchange_success"),show:()=>d.shop.mt_coupon_enable||d.shop.no_problem_coupon_enabled}],_=e.computed((()=>{var e;return null==(e=m.vipCoupon)?void 0:e.user_vip_score})),g=e.ref(q),k=e.reactive({coupon:{},activeTab:v.activeTab,loading:!1,paddingBottom:"40px"}),y=e.computed((()=>{var e,o;const n=null==(e=d.shop)?void 0:e.vip_type,u=(null==(o=m.vipCoupon)?void 0:o.coupon_packages)||[];return"mallcoo_ltg"===n?u.filter((e=>e.locker_type===C.value)):u})),C=e.computed((()=>m.orderOpt.locker_type)),T=e.computed((()=>{var e;return k.activeTab===s.CouponActiveTabEnum.VIP?!(null==(e=k.coupon)?void 0:e.id):!h.value}));e.watch((()=>v.visible),(async o=>{var n;await e.nextTick$1(),o?(g.value=q.filter((e=>e.show())),k.activeTab=v.activeTab||g.value[0].value,j.value=null==(n=q.find((e=>e.value===k.activeTab)))?void 0:n.name,b.value&&b.value.open()):b.value&&b.value.close()}),{immediate:!0});const x=()=>{l("update:visible",!1)},E=(e,o)=>e===i.payRuleTypeEnum.Count&&o===s.CouponTypeEnum.TIME,A=e=>!(e===C.value||!e),w=()=>{if(k.activeTab===s.CouponActiveTabEnum.VIP){const{id:e,vip_value:o,vip_number:n}=k.coupon||{};if(k.loading=!0,!e)return k.loading=!1,!1;t.couponApi.post({coupon_package_id:e,vip_value:o,vip_number:n,phone:m.phone}).then(I).finally((()=>{k.loading=!1}))}else{if(!h.value)return void p.toast(o.t("coupon.enter_or_paste_code"));const e=h.value.includes("wyc")?s.CouponChannelEnum.WUYOUCUN:s.CouponChannelEnum.MEITUAN;t.couponExchangeApi.post({code:h.value.replace(/\s+/g,""),shop_id:d.shop.id,consume_channel:e}).then(I)}},I=e=>{var n;const u=(null==(n=g.value.find((e=>e.value===k.activeTab)))?void 0:n.desc)||o.t("sub-pages.me.join-us.index.submit_success");h.value="",p.toast(u),l("confirm",{coupon:e,type:k.activeTab}),x()};return(n,u)=>e.e({a:e.o(x),b:e.p({title:e.unref(j)}),c:2===e.unref(g).length},2===e.unref(g).length?{d:e.o((o=>e.unref(k).activeTab=o)),e:e.p({list:e.unref(g),modelValue:e.unref(k).activeTab})}:{},{f:e.unref(k).activeTab===e.unref(s.CouponActiveTabEnum).VIP},e.unref(k).activeTab===e.unref(s.CouponActiveTabEnum).VIP?e.e({g:e.t(e.unref(o.t)("components.v1.coupon.coupon-popup.2")),h:e.t(e.unref(_)||0),i:e.unref(_),j:e.unref(y).length},e.unref(y).length?{k:e.f(e.unref(y),((n,u,i)=>{var s;return{a:"0b234b5f-3-"+i+",0b234b5f-0",b:e.p({coupon:n,type:"vip",active:(null==(s=e.unref(k).coupon)?void 0:s.id)===(null==n?void 0:n.id)}),c:"0b234b5f-4-"+i+",0b234b5f-0",d:null==n?void 0:n.id,e:e.o((e=>(e=>{var n;if(e.disabled)p.toast("v1.coupon.coupon-popup.1");else if(e.id!==(null==(n=k.coupon)?void 0:n.id)){const{payRule:{type:n}}=d;if(E(n,e.type)||A(e.locker_type))return p.toast(o.t("v1.coupon.coupon-popup.1")),!1;k.coupon=e}else k.coupon={}})(n)),null==n?void 0:n.id)}})),l:e.p({type:"checkmarkempty",size:"16",color:"#fff"})}:{m:e.p({description:e.unref(o.t)("coupon.no_exchangeable_coupons"),image:e.unref(r.config).fileBaseUrl+"/order_empty.png"})}):{n:e.unref(r.config).fileBaseUrl+"/coupon/popup-card-header.png",o:e.o(((...o)=>e.unref(f)&&e.unref(f)(...o))),p:e.o((o=>e.isRef(h)?h.value=o:null)),q:e.p({type:"text",maxlength:"20",size:"large",placeholder:e.unref(o.t)("coupon.enter_or_paste_code"),modelValue:e.unref(h)})},{r:e.t(e.unref(k).loading?e.unref(o.t)("components.v1.coupon.vip-coupon-popup.11"):e.unref(o.t)("components.v1.coupon.coupon-popup.9")),s:e.o(w),t:e.p({shape:"square",isBlock:!0,disabled:e.unref(T)}),v:e.unref(k).paddingBottom,w:e.sr(b,"0b234b5f-0",{k:"popup"}),x:e.p({type:"bottom","safe-area":!1,"is-mask-click":!1})})}}),h=e._export_sfc(m,[["__scopeId","data-v-0b234b5f"]]);wx.createComponent(h);
