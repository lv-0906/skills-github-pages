"use strict";const e=require("./pay.js"),r=require("../const/order.js");require("../common/vendor.js");const o=require("../local/index.js"),n=require("../hooks/uni-hooks/new-dialog.js");require("../store/modules/app.js");const t=require("../store/modules/device.js");require("../store/modules/order.js"),require("../store/modules/user.js"),require("../utils/uniAsync.js"),require("../utils/wx.log.js"),require("../utils/config/index.js"),require("../hooks/uni-hooks/dialog.js"),require("../hooks/uni-hooks/request.js");const s=require("../hooks/uni-hooks/router.js"),i=require("../hooks/uni-hooks/wechat.js"),u=require("../hooks/useWechatSI.js");require("../hooks/useCountryCode.js");const d=require("./device.js"),c=require("../hooks/use-keyval/index.js"),{OrderStatusTextMap:a}=c.useKeyval(),{autoPlay:l}=u.useWechatSI(),h=t.useDeviceStore();function f(e){return!!e&&!!e.is_owing}function p(e){var r;return!!e&&!(!e.is_pre_create||(null==(r=e.info)?void 0:r.pre_unlocked))}function m(e){const{unlock_count:r}=e,o=_(e);return 1e3===o||o-r>0}function _(e){const{info:r}=e||{};return null==r?void 0:r.site_unlock_count}const k=(e,r)=>{if(d.isOneCodOneCabinet()){if(e.locker_id===h.freeLocker.id)return!0}else if(e.reverse_cabinet_id===r||e.cabinet_id===r)return!0;return!1},b=(e,o,n)=>n===r.OrderButtonEnum.End||n===r.OrderButtonEnum.RenewEnd?e&&!o.reverse_end_disable||!e&&!o.front_end_disable:n===r.OrderButtonEnum.Open&&(e&&!o.reverse_unlock_disable||!e&&!o.front_unlock_disable);exports.enableUnlock=m,exports.isLongRental=function(e){if(!e)return!1;const{type:o,rental_period:n}=null==e?void 0:e.pay_rule;return o===r.OrderRentTypeEnum.Time&&n===r.RentalPeriodEnum.LONG_RENTAL},exports.isReserve=p,exports.onCloseOrder=e=>new Promise(((e,r)=>{l(o.t("shared.order.11")),n.specialMot.showModal("OrderCloseRef",{confirm:()=>e(!1),cancel:()=>e(!0)})})),exports.onEndOrder=function(e){return new Promise(((r,t)=>{l(o.t("shared.order.11")),n.specialMot.showModal("OrderOpenRef",{confirm:()=>{const e=o.t("shared.order.30");n.toast(e),t(e)},cancel:()=>{e.used_time<10?s.navigateTo(`/sub-pages/order/ten/index?orderId=${e.id}`):r(e.id)}})}))},exports.onHalfUnlock=function(e,r=!1){return new Promise(((t,s)=>{const i=_(e);if(i&&e.unlock_count>=i)return n.toast(`${o.t("shared.order.36")}${e.unlock_count}${o.t("shared.order.6")}`);l(o.t("shared.order.38")),r?t(e.id):n.specialMot.showModal("OrderOpenRef",{confirm:()=>t(e.id),cancel:()=>{const e=o.t("shared.order.44");n.toast(e),s(e)}})}))},exports.onLongUnlock=function(e){return new Promise(((r,t)=>{const s=o.t("order.detail.btn.unlock_rental"),i=o.t("shared.order.40"),u=o.t("shared.order.18"),d=o.t("button.cancel");l(o.t("shared.order.40")),n.confirm(i,s,u,d).then((()=>{r(e.id)})).catch((()=>{}))}))},exports.onPayHalfUnlock=function(e){return new Promise(((r,t)=>{e.pay_rule.prepaid>0?o.t("order.detail.btn.pay_unlock"):o.t("order.detail.btn.free_unlock"),m(e)?n.specialMot.showModal("OrderOpenRef",{confirm:()=>r(!0),cancel:()=>r(!1)}):r(!1)}))},exports.onPickUp=e=>new Promise(((e,r)=>{n.confirm(o.t("shared.order.21"),o.t("hooks.uni-hooks.dialog.5"),o.t("button.confirm"),o.t("button.cancel")).then((()=>{e(!0)})).catch((()=>{r()}))})),exports.onRenew=async function(o){const{site_id:n,id:t,money:s,payed:i,rent_type:u,coupon:d,optType:c,extension_minutes:a,payHalfUnlock:l,enterFrom:h}=o;let f=r.PayOrderTypeEnum.RenewEnd;c===r.OrderButtonEnum.Renew&&(f=r.PayOrderTypeEnum.Renew);const{pay_channel:p,order_method:m}=o.info;return await e.recharge({site_id:n,order_id:t,extension_minutes:a,pay_channel:m||p,money:s},f,{payHalfUnlock:l,enterFrom:h})},exports.scanToConfirm=function(e,r,t=!0){return new Promise(((s,u)=>{var d;((null==(d=null==r?void 0:r.info)?void 0:d.fetch_confirm_enable)||(null==r?void 0:r.reverse_cabinet_id))&&t?n.confirm(o.t("business.order-item.footer-button.1"),o.t("hooks.uni-hooks.dialog.5"),o.t("business.order-item.footer-button.2")).then((()=>{i.envEvent.scanCode().then((async t=>{await h.fetchCabinet(t,!0);const{id:i,is_reverse:d,binding_cabinet_id:c,binding_config:a}=h.cabinet,l=k(r,i);if(l||(n.alert(o.t("business.order-item.footer-button.5")),u()),a&&c){const r=b(d,a,e);l&&!r&&(n.alert(o.t("business.order-item.footer-button.3")),u())}s(!0)}))})):s(!0)}))},exports.showOrderStatusText=e=>e?e.status===r.OrderStatusEnum.Done?o.t("sub-pages.me.order.components.order.1"):p(e)?o.t("order.status.reserving"):f(e)?o.t("order.detail.status.timeout"):a.value[e.status]:"",exports.showOwing=f,exports.showUnlockText=function(e){if(!e)return"";const{unlock_count:r}=e,n=_(e);return 1e3===n?o.t("shared.order.3"):r>=n?o.t("shared.order.4"):`${o.t("shared.order.5")}${n-r}${o.t("shared.order.6")}`};
