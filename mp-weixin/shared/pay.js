"use strict";require("../common/vendor.js"),require("../local/index.js"),require("../hooks/uni-hooks/new-dialog.js"),require("../store/modules/app.js");const e=require("../store/modules/device.js");require("../store/modules/order.js"),require("../store/modules/user.js");const r=require("../utils/is.js"),t=require("../const/order.js"),o=require("../const/platform.js");require("../utils/uniAsync.js");const s=require("../utils/wx.log.js");require("../utils/config/index.js"),require("../hooks/uni-hooks/dialog.js"),require("../hooks/uni-hooks/request.js");const i=require("../hooks/uni-hooks/unite.js"),n=require("../hooks/uni-hooks/wechat.js"),a=require("../hooks/usePromise.js");require("../hooks/useCountryCode.js");const u=require("../api/order.js");e.useDeviceStore();function d({payed:e,site_id:r,order_data:d},c=t.PayOrderTypeEnum.Create,p=o.PlatformEnum,m={}){return new Promise((async(m,l)=>{let y,j;p=o.PlatformEnum;const q=t.PayOrderTypeEnumMap[c].pre_order_type;if([y,j]=await a.usePromise(u.orderApi.postPreOrders(e,r,d,q,p)),y)return n.envEvent.report.error(y),l(y);s.LOG("[ topUp.postPreOrders.preData ] >",j);const{pay_data:_}=j,{nonce_str:h,pay_sign:P,sign_type:k,time_stamp:g,trade_no:O,package:w}=_;i.unite.requestPayment({tradeNo:O,timeStamp:g,nonceStr:h,tPackage:w,signType:k,paySign:P}).then((()=>{m(j)})).catch(l)}))}exports.recharge=async function({site_id:e,order_id:r,pay_channel:t,extension_minutes:o,money:s},i,n={}){let{payed:a,total_payed:c}=await u.paymentApi.payed({site_id:e,order_id:r,extension_minutes:o,money:s});if(a>0){return{payed:a,data:await d({site_id:e,payed:a,order_data:{order_id:r,money:c,extension_minutes:o}},i,t,n)}}return{payed:a,data:await u.lockerOrderApi.recharge(r,c,o)}},exports.topUp=d,exports.transactionPreOrderResult=function(e){let o=0;const s=async(i,n)=>{const a=await u.orderApi.getPreOrders(e);console.log("--------transactionPreOrderResult------");let{status:d,result:c,order:p}=a||{};r.isEmptyObject(c)?o=setTimeout((()=>{clearTimeout(o),s(i,n)}),500):(o&&clearTimeout(o),0!==(null==c?void 0:c.code)||r.isEmptyObject(p)||d!==t.payStatusEnum.Paid?n(c):i(a))};return{promise:new Promise(s),clearTime:()=>{o&&clearTimeout(o)}}};
