"use strict";const e=require("../../local/index.js"),r=require("../../const/order.js"),n=require("../../common/vendor.js"),o=require("../uni-hooks/new-dialog.js");require("../../store/modules/app.js");const t=require("../../store/modules/device.js");require("../../store/modules/order.js"),require("../../store/modules/user.js"),require("../../utils/uniAsync.js"),require("../../utils/wx.log.js"),require("../../utils/config/index.js");const d=require("../uni-hooks/dialog.js");require("../uni-hooks/request.js");const s=require("../uni-hooks/router.js");require("../uni-hooks/wechat.js");const u=require("../useWechatSI.js"),i=require("../../api/order.js");require("../useCountryCode.js");const a=require("../../shared/order.js");require("../../shared/pay.js");exports.useBtnOperate=c=>{const{autoPlay:l}=u.useWechatSI(),O=t.useDeviceStore(),p=n.reactive({order:{},showSlid:!1,showRecharge:!1,slidType:r.OrderButtonEnum.End}),m=async(e,r)=>{await O.open(e,{},{catchError:!0,homePage:!1}),s.navigateTo(`/pages/order/result/index?orderId=${e}&from=${r}`)},E=async n=>{const{optType:o,fetchUser:t}=n;a.onRenew(n).then((async u=>{if(o===r.OrderButtonEnum.Renew)return d.toast(e.t("pages.v1.index.index.21")),c&&c(),t&&t(),void((null==n?void 0:n.payHalfUnlock)&&m(n.id,r.OrderResultEnum.UNLOCK));if(o===r.OrderButtonOptionEnum.RenewEnd)return await i.lockerOrderApi.end(p.order.id),void s.navigateTo(`/pages/order/result/index?orderId=${p.order.id}&from=${r.OrderResultEnum.DONE}`);if(o===r.OrderButtonOptionEnum.RenewOpen)return void m(n.id,r.OrderResultEnum.UNLOCK);const{data:{display_id:a},payed:l}=u;let O=`/pages/order/unlock/index?from=${r.OrderResultEnum.DONE}&orderId=${n.id}`;l>0&&(O+=`&displayId=${a}`),s.navigateTo(O)}))};return{useBtnOperateState:p,cbOrderItem:({type:n,order:t})=>{switch(p.order={...t,optType:n},n){case r.OrderButtonEnum.End:a.onEndOrder(t).then((()=>{p.slidType=r.OrderButtonEnum.End,p.showSlid=!0,l(e.t("pages.v1.index.index.6"))}));break;case r.OrderButtonOptionEnum.RenewEnd:case r.OrderButtonOptionEnum.RenewOpen:p.showRecharge=!0;break;case r.OrderButtonOptionEnum.End:o.confirm(e.t("sub-pages.order.exception.mqtt.index.21"),e.t("hooks.uni-hooks.dialog.5")).then((async()=>{await i.lockerOrderApi.end(p.order.id),s.navigateTo(`/pages/order/result/index?orderId=${p.order.id}&from=${r.OrderResultEnum.DONE}`)}));break;case r.OrderButtonOptionEnum.Open:a.onLongUnlock(t).then((e=>{m(e,r.OrderResultEnum.LONG_UNLOCK)}));break;case r.OrderButtonEnum.Close:a.onCloseOrder().then((n=>{var o;if(n)p.slidType=r.OrderButtonEnum.Close,p.showSlid=!0,l(e.t("pages.v1.index.index.8"));else{const r=getCurrentPages(),n=r.length;if("sub-pages/order/pick/index"===(null==(o=r[n-1])?void 0:o.route))return void d.toast(e.t("shared.order.22"));a.onPickUp().then((()=>{var e;n>=2&&"sub-pages/order/pick/index"===(null==(e=r[n-2])?void 0:e.route)?s.navigateBack():s.redirectTo("/sub-pages/order/pick/index")}))}}));break;case r.OrderButtonEnum.Renew:p.showRecharge=!0;break;case r.OrderButtonEnum.RenewEnd:a.onPayHalfUnlock(t).then((e=>{if(e)p.order=Object.assign(p.order,{payHalfUnlock:!0,optType:r.OrderButtonEnum.Renew}),p.showRecharge=!0;else{if(t.rent_type===r.OrderRentTypeEnum.Free)return void E(p.order);p.showRecharge=!0}}));break;case r.OrderButtonEnum.Open:a.onHalfUnlock(t).then((e=>{m(e,r.OrderResultEnum.UNLOCK)}));break;case r.OrderButtonEnum.LONG_OPEN:a.onLongUnlock(t).then((e=>{m(e,r.OrderResultEnum.LONG_UNLOCK)}))}},cbRenew:E,cbSlideConfirm:async({type:e})=>{if(e===r.OrderButtonEnum.Close)return await i.lockerOrderApi.end(p.order.id),void s.navigateTo(`/pages/order/result/index?orderId=${p.order.id}&from=${r.OrderResultEnum.DONE}`).then((()=>{c&&c()}));s.navigateTo(`/pages/order/unlock/index?orderId=${p.order.id}&from=${r.OrderResultEnum.DONE}`)}}};
