"use strict";var e=Object.defineProperty,r=(r,t,s)=>(((r,t,s)=>{t in r?e(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s})(r,"symbol"!=typeof t?t+"":t,s),s);const t=require("../../common/vendor.js"),s=require("../../local/index.js"),o=require("./new-dialog.js");require("../../store/modules/app.js"),require("../../store/modules/device.js"),require("../../store/modules/order.js");const i=require("../../store/modules/user.js");require("./dialog.js");const u=require("./wechat.js"),a=require("../use-common.js");require("../useCountryCode.js"),require("../../utils/uniAsync.js"),require("../../utils/wx.log.js");const n=require("../../utils/config/index.js"),h=require("../../shared/cache.js"),c=require("./loading.js");let l=!1;class d{constructor(e){r(this,"header"),r(this,"config"),r(this,"requestQueue",[]),r(this,"apiKey",n.config.api.apiKey),this.config=e,this.header=e.header}get(e,r,t={}){return this.request({url:e,params:r,method:"GET",...t})}post(e,r,t={}){return this.request({url:e,params:r,method:"POST",...t})}put(e,r,t={}){return this.request({url:e,params:r,method:"PUT",...t})}delete(e,r,t={}){return this.request({url:e,params:r,method:"DELETE",...t})}request(e){const{url:r,params:s,method:o,loading:i=!0,catchError:a=!0,options:l={}}=e;return i&&c.startTimer(),new Promise((async(e,d)=>{let p=h.getTokenStorage();p&&(p="Motern "+p),console.log(`request [${o}]${r}`,s,p),this.header=this.setHeader(this.header),t.index.request({url:this.joinBaseUrl(r),data:s,header:{...this.header,Authorization:p||""},method:o,dataType:l&&(null==l?void 0:l.dataType)||"json",responseType:"text",success:t=>{const{data:u,statusCode:n}=t;if(r.includes("html")||console.log(`request success [${o}]${r}`,n,u),200===n){const{Result:r}=u;return e(r||u)}if(401===n)return h.removeTokenStorage(),void this.refreshToken(r,s,o,i,!1,e);a&&this.catchErrorMsg(t),d(u)},fail:t=>{if(u.envEvent.report.error(`request err [${o}]${r}err:${JSON.stringify(t)}`),n.config.isMpAlipay)return 401===t.statusCode?(h.removeTokenStorage(),void this.refreshToken(r,s,o,i,!1,e)):(a&&this.catchErrorMsg(t),void d(t.data));a&&this.catchApiError(t),d(t)},complete:()=>{i&&c.clearTimer()}})}))}joinBaseUrl(e){if((null==e?void 0:e.startsWith("http://"))||(null==e?void 0:e.startsWith("https://")))return e;const{baseURL:r,prefix:t}=this.config;return t?`${r}/${t}${e}`:r+e}setHeader(e){const r=(new Date).getTime();return e.Timestamp=r,e.Sign=t.cryptoJsExports.MD5(r+this.apiKey).toString(),e}catchErrorMsg(e){const{data:r}=e,{ErrCode:t,ErrMsg:i}=r||{};t?o.alert(i):o.toast(s.t("hooks.uni-hooks.request.4"))}catchApiError(e){const{errno:r}=e;let t=s.t("uni-hooks.request.3");switch(r){case 5:t=s.t("uni-hooks.request.3");break;case 600003:t=s.t("hooks.uni-hooks.request.7");break;default:t=s.t("hooks.uni-hooks.request.10")}o.alert(t)}refreshToken(e,r,t,s,o,u){if(h.removeTokenStorage(),this.requestQueue.push((()=>{u(this.request({url:e,params:r,method:t,loading:s,catchError:o}))})),!l){l=!0;i.useUserStore().login().then((async e=>{e&&a.useGlobalUserInfo(),this.requestQueue.map((e=>{e()})),this.requestQueue=[]})).finally((()=>{l=!1}))}}}const p=function(){const{timeout:e,baseURL:r,prefix:t,xAppId:s}=n.config.api;return new d({timeout:e,baseURL:r,prefix:t,header:{"content-type":"application/json; charset=utf-8","Xi-App-Id":s}})}();exports.defHttp=p;
