"use strict";const e=require("../../../../common/vendor.js");require("../../../../store/modules/app.js"),require("../../../../store/modules/device.js"),require("../../../../store/modules/order.js");const o=require("../../../../store/modules/user.js"),r=require("../../../../utils/dayjs.js");require("../../../../local/index.js");const s=require("../../../../utils/is.js"),i=require("../../../../const/order.js");require("../../../../utils/uniAsync.js");const u=require("../../../../utils/validate.js");require("../../../../utils/wx.log.js"),require("../../../../utils/config/index.js");const t=require("../../../../hooks/uni-hooks/new-dialog.js");require("../../../../hooks/uni-hooks/dialog.js"),require("../../../../hooks/uni-hooks/request.js");const n=require("../../../../hooks/uni-hooks/router.js"),a=require("../../../../hooks/uni-hooks/wechat.js"),p=require("../../../../api/coupon.js");require("../../../../hooks/useCountryCode.js");const d=require("../../../../hooks/use-mix.js");require("../../../../shared/order.js"),require("../../../../shared/pay.js");const l=require("../../../../shared/user.js");if(require("../../../../api/device.js"),require("../../../../api/order.js"),require("../../../../api/user.js"),require("../../../../hooks/usePromise.js"),require("../../../../api/delivery.js"),require("../../../../shared/cache.js"),require("../../../../const/cache.js"),require("../../../../hooks/uni-hooks/cache.js"),require("../../../../shared/device.js"),require("../../../../const/common.js"),require("../../../../utils/appEnterVerif.js"),require("../../../../hooks/uni-hooks/unite.js"),require("../../../../const/platform.js"),require("../../../../utils/config/env.js"),require("../../../../uni_modules/mot-utils/index.js"),require("../../../../theme/hooks/useTheme.js"),require("../../../../theme/hooks/themeConfig.js"),require("../../../../theme/hooks/themeKeys.js"),require("../../../../hooks/use-common.js"),require("../../../../hooks/uni-hooks/loading.js"),require("../../../../hooks/uni-hooks/common.js"),require("../../../../utils/url.js"),require("../../../../hooks/uni-hooks/report.js"),require("../../../../api/data.js"),require("../../../../utils/precision.js"),require("../../../../hooks/useWechatSI.js"),require("../../../../hooks/use-keyval/index.js"),require("../../../../const/coupon.js"),!Array){(e.resolveComponent("mot-button")+e.resolveComponent("uni-popup"))()}Math||(c+h+(()=>"../../../../uni_modules/mot-button/components/mot-button/mot-button.js")+(()=>"../../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const c=()=>"../../../../components/popup-header/index.js",h=()=>"../../../../components/input/index.js",m=e.defineComponent({__name:"index",props:{modelValue:{type:Boolean,default:!1},orderInfo:{type:Object,default:()=>{}}},emits:["update:modelValue","confirm","update:loading"],setup(c,{emit:h}){const m=c,j=o.useUserStore(),q=e.reactive({phone:j.user.phone,loading:!1}),k=e.computed({get:()=>m.modelValue,set:e=>h("update:modelValue",e)}),v=e.ref();e.watch((()=>m.modelValue),(async o=>{await e.nextTick$1(),o?v.value&&v.value.open():v.value&&v.value.close()}),{immediate:!0});const f=()=>{k.value=!1,a.envEvent.report.commonClk("权益购买页_立即升级弹窗_关闭点击")},g=async()=>{if(u.isPhone(q.phone)){if(!q.loading){if(a.envEvent.report.commonClk("权益购买页_确认升级弹窗_确认支付按钮点击"),q.loading=!0,t.showLoading("支付中，请稍后"),!j.user.phone){const e=u.trim(q.phone),o=await l.setPhone({phone:e,type:"input"});j.setUserInfo({...j.user,phone:o})}try{const{display_id:e}=await p.vipApi.pre_orders({phone:q.phone,vip_package_id:m.orderInfo.id}),{promise:o}=y(10,e);o.then((e=>{q.loading=!1;const{order:o}=e;console.log("order:",o),o.id&&(a.envEvent.report.commonClk("权益购买页_确认升级弹窗_确认支付按钮点击_支付成功"),n.reLaunch(`/sub-pages/activity-vip/buy-result?order.id=${o.id}`))})).catch((()=>{t.hideLoading(),t.toast("支付失败, 请重试"),q.loading=!1}))}catch(e){t.hideLoading(),t.toast("预创建订单失败，请稍后重试"),q.loading=!1}}}else t.toast("请输入正确的手机号")},y=(e,o)=>{let r=0;let u=0;const t=async(n,a)=>{if(u>=e)return void a("支付超时");const d=await p.vipApi.get_result(o);console.log("--------transactionPreOrderResult------");let{status:l,result:c,order:h}=d||{};s.isEmptyObject(c)?r=setTimeout((()=>{clearTimeout(r),t(n,a),u++}),2e3):(r&&clearTimeout(r),0!==(null==c?void 0:c.code)||s.isEmptyObject(h)||l!==i.payStatusEnum.Paid?a(c):n(d))};return{promise:new Promise(t)}};return(o,s)=>{var i;return{a:e.o(f),b:e.p({title:"确认升级"}),c:e.o((o=>e.unref(q).phone=o)),d:e.p({type:"number",maxlength:"11",placeholder:"请输入手机号",modelValue:e.unref(q).phone}),e:e.t(e.unref(r.getToday)()),f:e.t(e.unref(r.getNextYearToday)(1,1)),g:e.t(e.unref(q).loading?"正在升级中":e.unref(d.useToYuan)(null==(i=c.orderInfo)?void 0:i.price)+" 确认升级"),h:e.o(g),i:e.p({isBlock:!0,loading:e.unref(q).loading,type:"primary",size:"normal",shape:"square"}),j:e.sr(v,"7f423685-0",{k:"popup"}),k:e.p({"safe-area":!1,type:"bottom",borderRadius:"10px","is-mask-click":!1})}}}}),j=e._export_sfc(m,[["__scopeId","data-v-7f423685"]]);wx.createComponent(j);
