"use strict";const e=require("../../../common/vendor.js"),o=require("../../../const/order.js"),r=require("../../../const/platform.js"),n=require("../../../const/emit.js"),s=require("../../../local/index.js");require("../../../hooks/uni-hooks/new-dialog.js"),require("../../../store/modules/app.js");const a=require("../../../store/modules/device.js");require("../../../store/modules/order.js");const t=require("../../../store/modules/user.js"),i=require("../../../utils/clone.js"),u=require("../../../utils/is.js");require("../../../utils/uniAsync.js"),require("../../../utils/wx.log.js");const d=require("../../../utils/config/index.js"),l=require("../../../hooks/uni-hooks/dialog.js"),c=require("../../../hooks/uni-hooks/emitKey.js");require("../../../hooks/uni-hooks/request.js");const p=require("../../../hooks/uni-hooks/router.js");require("../../../hooks/uni-hooks/wechat.js");const m=require("../../../api/order.js");require("../../../hooks/useCountryCode.js");const y=require("../../../hooks/use-mix.js"),h=require("../../../shared/cache.js");require("../../../shared/order.js");const g=require("../../../shared/pay.js"),f=require("./hook.js"),_=require("./const.js");if(require("../../../hooks/uni-hooks/unite.js"),require("../../../utils/config/env.js"),require("../../../uni_modules/mot-utils/index.js"),require("../../../theme/hooks/useTheme.js"),require("../../../theme/hooks/themeConfig.js"),require("../../../theme/hooks/themeKeys.js"),require("../../../api/device.js"),require("../../../api/user.js"),require("../../../hooks/usePromise.js"),require("../../../api/delivery.js"),require("../../../shared/device.js"),require("../../../const/common.js"),require("../../../utils/appEnterVerif.js"),require("../../../hooks/use-common.js"),require("../../../hooks/uni-hooks/loading.js"),require("../../../hooks/uni-hooks/common.js"),require("../../../utils/url.js"),require("../../../hooks/uni-hooks/report.js"),require("../../../api/data.js"),require("../../../utils/precision.js"),require("../../../const/cache.js"),require("../../../hooks/uni-hooks/cache.js"),require("../../../hooks/useWechatSI.js"),require("../../../hooks/use-keyval/index.js"),require("../../../const/coupon.js"),!Array){(e.resolveComponent("mot-button")+e.resolveComponent("mot-modal"))()}Math||((()=>"../../../uni_modules/mot-button/components/mot-button/mot-button.js")+(()=>"../../../uni_modules/mot-modal/components/mot-modal/mot-modal.js"))();const j=e.defineComponent({__name:"index",setup(j){const{currentPayWay:v,payWays:k}=f.usePayCenter(h.getPayWayStorage()),{showPayComfirm:q,onShowPayComfirm:b}=f.usePopupComfirm(),P=a.useDeviceStore(),E=e.ref(!1),x=e.computed((()=>h.getPayWayStorage().payed));let O=()=>{};const T=async()=>{E.value=!0;const{payed:n,site_id:a,order_data:t,order_type:i,otherInfo:u}=h.getPayWayStorage();try{const c=o.PayOrderTypeEnumMap[i].pre_order_type,{ua:y}=e.index.getSystemInfoSync(),f=y||"",j=f.includes("iPhone")||f.includes("iPad")?_.PlatformPayEnum.IOS:_.PlatformPayEnum.ANDROID,k=f.toLowerCase().includes("alipayconnect"),q=await m.orderApi.postPreOrders(n,a,t,c,v.value,j),{pay_data:b,display_id:P}=q;if(v.value===r.PlatformEnumPayEnum.pos)return void C(i,P,n,u.payHalfUnlock);if(null==b?void 0:b.qr_code_url){if(v.value===r.PlatformEnumPayEnum.ali&&k){console.log("支付宝支付-AlipayConnect");const e=encodeURIComponent(null==b?void 0:b.qr_code_url),o="https://ds.alipay.com/?from=mobilecodec&scheme="+encodeURIComponent("alipays://platformapi/startapp?saId=10000007&clientVersion=3.7.0.0718&qrcode="+e);window.location.href=o}else console.log("支付-原逻辑"),window.location.href=b.qr_code_url;h.setPayWayStorage({...h.getPayWayStorage(),display_id:P,pay_channel:v.value})}if(E.value=!1,O&&O(),P)try{const{promise:e,clearTime:o}=g.transactionPreOrderResult(P);console.log("------pay-center------","------transactionPreOrderResult------"),O=o;const r=await e,{order:s}=r;w({order_type:i,order_id:s.id,display_id:P,payed:n,traceId:null==t?void 0:t.trace_id})}catch(d){const{code:e=5001,msg:o=s.t("sub-pages.coupon.index.27")}=d||{};l.dialog.alert(`${o}(${e})`).then(p.goHome)}}catch(d){E.value=!1,l.dialog.alert(s.t("sub-pages.common.pay-center.index.11")).then(p.goHome)}},w=async({order_type:e,order_id:r,display_id:n,payed:s,traceId:a})=>{switch(e){case o.PayOrderTypeEnum.Create:R(o.OrderResultEnum.CREATE,n);break;case o.PayOrderTypeEnum.Forget:$(o.OrderResultEnum.FORGET,r,n);break;case o.PayOrderTypeEnum.Renew:S(r);break;case o.PayOrderTypeEnum.RenewEnd:const{otherInfo:e}=h.getPayWayStorage();if(console.log("------otherInfo------",null==e?void 0:e.enterFrom),console.log("------otherInfo.fetchUser------",e),"jd"===(null==e?void 0:e.enterFrom)||"jd_again"===(null==e?void 0:e.enterFrom)){console.log("------进入jd_renew------");const o=await m.lockerOrderApi.get(r);return console.log(o),void I(o,null==e?void 0:e.enterFrom)}W(r,n,s);break;case o.PayOrderTypeEnum.Coupon:L(r,s);break;case o.PayOrderTypeEnum.JdCreate:R(o.OrderResultEnum.JDCREATE,n);break;case o.PayOrderTypeEnum.JdCancel:$(o.OrderResultEnum.JDCANCEL,r,n,a)}h.setPayWayStorage({})},I=async(o,r)=>{var s,a,u,d,l,c;const m=t.useUserStore();if(!(null==(s=null==o?void 0:o.info)?void 0:s.cabinet_scene))return;await m.fetchUser(),await P.fetchCabinet({id:null==(a=null==o?void 0:o.info)?void 0:a.cabinet_scene},!0);const y=(null==(u=m.jdOrderOpt)?void 0:u.data)||{},h=i.deepClone(y),{province:g,city:f,region:_,address:j="",id:v}=P.site,{address:k}=P.cabinet,q=`${j}${k?""+(j?"-":"")+k:""}`;h.sender_contact=Object.assign({},h.sender_contact,{province:g,city:f,area:_,address:q,mobile:m.phone||""}),m.setJdOrderOpt({locker_order_id:o.id,locker_id:o.locker_id,locker_name:null==(d=o.info)?void 0:d.locker_name,locker_type:null==(l=o.info)?void 0:l.locker_type,rental_period:null==(c=o.pay_rule)?void 0:c.rental_period,site_id:v,data:h}),p.redirectTo("/sub-pages/v2/xd/deposit/index?from=order").then((()=>{var r,s;e.index.$emit(n.EMIT_GET_LOCKER_RULE,{locker_type:null==(r=o.info)?void 0:r.locker_type,rental_period:null==(s=o.pay_rule)?void 0:s.rental_period})}))},C=(e,o,r,n)=>{let s=`/sub-pages/order/wait-pos/index?from=${e}&displayId=${o}&payed=${r}&payHalfUnlock=${n}`;p.reLaunch(s)},R=(e,o)=>{let r=`/pages/order/open/index?from=${e}`;o&&(r+=`&displayId=${o}`),p.reLaunch(r)},$=(e,o,r,n="")=>{const s=`${e}&orderId=${o}&displayId=${r}&traceId=${n}`;p.redirectTo(`/pages/order/unlock/index?from=${s}`)},S=async o=>{l.toast(s.t("pages.v1.index.index.21"));const{otherInfo:r}=h.getPayWayStorage();(null==r?void 0:r.payHalfUnlock)&&await P.open(o,{},{catchError:!0,homePage:!1}),e.index.$emit(c.EMIT_REFRESH_HOME),p.goHome()},W=(e,r,n)=>{let s=`/pages/order/unlock/index?from=${o.OrderResultEnum.DONE}&orderId=${e}`;n>0&&(s+=`&displayId=${r}`),p.redirectTo(s)},L=(e,o)=>{p.reLaunch(`/sub-pages/me/coupon-result/index?couponPackageId=${e}&payed=${o}`)},A=async()=>{await U()&&l.dialog.alert(s.t("sub-pages.common.pay-center.index.11")).then(p.goHome)},H=e.ref(0),U=(r=!1)=>new Promise((async(n,s)=>{const{display_id:a,order_type:t,payed:i,optType:d,order_data:c}=h.getPayWayStorage();if(a){let s=0;e.index.showLoading(),H.value++,console.log("------checkTime.value-----",H.value);const d=await m.orderApi.getPreOrders(a);let{status:y,result:h,order:g}=d||{};u.isEmptyObject(h)?r&&H.value<5?s=setTimeout((async()=>{clearTimeout(s);const e=await U(r);console.log("------payStatus-----",e),n(e)}),1e3):(H.value=0,s&&clearTimeout(s),e.index.hideLoading(),n(!0)):(H.value=0,s&&clearTimeout(s),e.index.hideLoading(),0!==(null==h?void 0:h.code)||u.isEmptyObject(g)||y!==o.payStatusEnum.Paid?l.dialog.alert(null==h?void 0:h.msg).then(p.goHome):(console.log("-----支付成功-------"),w({order_type:t,order_id:g.id,display_id:a,payed:i,traceId:null==c?void 0:c.trace_id})))}}));e.onShow((async()=>{const e=await U(!0);if(console.log("------status------",e),e){const e=setTimeout((()=>{b(),clearTimeout(e)}),1e3)}}));const F=e.ref();return(o,r)=>({a:e.unref(d.config).fileBaseUrl+"/pay/pay.png",b:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.1")),c:e.t(e.unref(y.useToYuan)(e.unref(x))),d:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.2")),e:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.3")),f:e.f(e.unref(k),((o,r,n)=>e.e({a:o.icon,b:e.n(o.class?o.class:"iconfontcabinet-img"),c:o.label},o.label?{d:e.t(null==o?void 0:o.label)}:{},{e:e.f(null==o?void 0:o.bottomIconList,((e,o,r)=>({a:e,b:e}))),f:e.n((null==o?void 0:o.value)===e.unref(v)?"motcabinet-success-filling primary":"motcabinet-huibiankuang"),g:o.value,h:e.o((e=>(e=>{v.value=e.value})(o)),o.value)}))),g:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.4")),h:e.o(T),i:e.p({loading:e.unref(E),shape:"square",isBlock:!0}),j:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.9")),k:e.t(e.unref(s.t)("sub-pages.common.pay-center.index.10")),l:e.o(T),m:e.o(A),n:e.o((o=>e.isRef(q)?q.value=o:null)),o:e.p({title:e.unref(s.t)("sub-pages.common.pay-center.index.6"),cancelText:e.unref(s.t)("sub-pages.common.pay-center.index.7"),confirmText:e.unref(s.t)("sub-pages.common.pay-center.index.8"),modelValue:e.unref(q)}),p:e.sr(F,"4746f9c9-2",{k:"ModalRef"}),q:e.p({id:"ModalRef"})})}}),v=e._export_sfc(j,[["__scopeId","data-v-4746f9c9"]]);wx.createPage(v);
