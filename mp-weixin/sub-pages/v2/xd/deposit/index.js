"use strict";const e=require("../../../../common/vendor.js"),o=require("../../../../const/order.js"),r=require("../../../../const/site.js"),s=require("../../../../const/emit.js"),i=require("../../../../utils/format.js"),t=require("../../../../local/index.js"),n=require("../../../../hooks/uni-hooks/new-dialog.js");require("../../../../store/modules/app.js");const a=require("../../../../store/modules/device.js");require("../../../../store/modules/order.js");const u=require("../../../../store/modules/user.js"),d=require("../../../../hooks/uni-hooks/dialog.js");require("../../../../hooks/uni-hooks/request.js");const l=require("../../../../hooks/uni-hooks/router.js");require("../../../../hooks/uni-hooks/wechat.js");const c=require("../../../../hooks/usePromise.js"),p=require("../../../../api/device.js"),_=require("../../../../api/delivery.js");require("../../../../hooks/useCountryCode.js");const m=require("../../../../hooks/use-mix.js");require("../../../../utils/uniAsync.js"),require("../../../../utils/wx.log.js");const v=require("../../../../utils/config/index.js");require("../../../../shared/order.js");const f=require("../../../../shared/pay.js");if(require("../../../../hooks/uni-hooks/unite.js"),require("../../../../const/platform.js"),require("../../../../shared/cache.js"),require("../../../../const/cache.js"),require("../../../../hooks/uni-hooks/cache.js"),require("../../../../utils/config/env.js"),require("../../../../uni_modules/mot-utils/index.js"),require("../../../../theme/hooks/useTheme.js"),require("../../../../theme/hooks/themeConfig.js"),require("../../../../theme/hooks/themeKeys.js"),require("../../../../api/order.js"),require("../../../../api/user.js"),require("../../../../shared/device.js"),require("../../../../const/common.js"),require("../../../../utils/appEnterVerif.js"),require("../../../../hooks/use-common.js"),require("../../../../hooks/uni-hooks/loading.js"),require("../../../../hooks/uni-hooks/common.js"),require("../../../../utils/url.js"),require("../../../../hooks/uni-hooks/report.js"),require("../../../../api/data.js"),require("../../../../utils/precision.js"),require("../../../../hooks/useWechatSI.js"),require("../../../../hooks/use-keyval/index.js"),require("../../../../const/coupon.js"),require("../../../../utils/is.js"),!Array){(e.resolveComponent("mot-button")+e.resolveComponent("mot-modal"))()}Math||(j+h+k+(()=>"../../../../uni_modules/mot-button/components/mot-button/mot-button.js")+(()=>"../../../../uni_modules/mot-modal/components/mot-modal/mot-modal.js")+y+q)();const j=()=>"./components/header.js",h=()=>"./components/locker-info.js",k=()=>"./components/basic-insurance.js",q=()=>"./components/worth-popup.js",y=()=>"./components/pay-popup.js",g=e.defineComponent({__name:"index",setup(j){const h=u.useUserStore(),k=a.useDeviceStore(),q=e.computed((()=>h.jdOrderOpt||{})),y=e.ref(!1),g=e.ref(!1),E=e.reactive({loading:!1,payRule:{},paid:0,total_paid:0,trace_id:"",delivery_promise_time_desc:""}),x=e.computed((()=>{const{province:e="",city:o="",region:r="",address:s=""}=k.site,{address:i=""}=k.cabinet;return`${e}${o}${r}${s}${i?`-${i}`:""}`})),w=()=>{var e;q.value;const o=(null==(e=q.value)?void 0:e.data)||{},{cargoes:r,receiver_contact:s,sender_contact:i}=o;(null==s?void 0:s.name)&&(null==i?void 0:i.name)&&!g.value&&$()},b=e=>{console.log("-----EMIT_GET_LOCKER_RULE  fetchApi   -----"),R(e)};e.onLoad((o=>{const{from:r=""}=o||{};if("order"===r){console.log("-----onload     fetchApi   -----");const{locker_type:e,rental_period:o}=q.value;R({locker_type:e,rental_period:o})}e.index.$on(s.EMIT_GET_LOCKER_RULE,b)})),e.onUnload((()=>{e.index.$off(s.EMIT_GET_LOCKER_RULE,b)})),e.onShow((async()=>{E.loading=!1,w(),console.log(q.value)}));const R=async e=>{const o=k.siteId,{rental_period:r,locker_type:s}=e;console.log("-----获取收费规则------");try{const e=await p.deviceApi.payRule(o,s,r);if(!e)return void n.alert(t.t("sub-pages.order.deposit.index.25"));console.log(`-----拿到收费规则id${e.id}------`),E.payRule=e,k.setPayRule(e),h.setJdOrderOpt({pay_rule_id:null==e?void 0:e.id})}catch(i){throw console.log(i,"fetchApi:error"),new Error(JSON.stringify(i))}},$=async()=>{var e;const o=(null==(e=q.value)?void 0:e.data)||{},[r,s]=await c.usePromise(_.DeliveryApi.orderPreCheck(o));if(r)return y.value=!1,E.paid=0,E.total_paid=0,E.trace_id="",Promise.reject(r);y.value=!0;const{delivery_promise_time_desc:i="",products:t=[]}=s;E.delivery_promise_time_desc=i;const{site_id:n,locker_id:a}=q.value;n&&a&&O()},O=async()=>{console.log("-----下单页获取支付金额------");const[e,o]=await c.usePromise(_.DeliveryApi.getExpressPaid(q.value));if(e)return y.value=!1,Promise.reject(e);const{paid:r,total_paid:s,trace_id:i}=o;E.paid=r,E.total_paid=s,E.trace_id=i},C=async()=>{try{const e=await L();await P(e)}catch(e){E.loading=!1}},L=async()=>{const{locker_order_id:e,locker_id:o}=q.value;if(!e){const e=await(async()=>{const e=k.freeLocker;return k.assignLocker(k.cabinet.id,q.value.locker_type,e.id,e.touch_at,r.lockerSenceMap.express)})();if(o!==e.id){const o=`${t.t("v1.deposit.index.3")}${i.fullLockerName(e.name,k.cabinet.address)}${t.t("v1.deposit.index.5")}`;await d.dialog.showModal({content:o}),k.setFreeLocker(e),h.setJdOrderOpt({locker_name:e.name,locker_id:e.id})}}return T()},T=()=>{const{locker_id:e,site_id:o,locker_order_id:r,pay_rule_id:s}=q.value,i={locker_id:e,site_id:o,trace_id:E.trace_id,locker_order_id:r,pay_rule_id:s};return h.setJdOrderOpt({trace_id:E.trace_id}),i},P=async e=>{console.log(e);const{paid:r}=E,{site_id:s}=q.value;if(r>0){const{display_id:i}=await f.topUp({payed:r,site_id:s,order_data:e},o.PayOrderTypeEnum.JdCreate);return g.value=!0,void A(i,r)}A()},A=(e,r)=>{let s=`/pages/order/open/index?from=${o.OrderResultEnum.JDCREATE}`;e&&(s+=`&displayId=${e}&payed=${r}`),l.reLaunch(s),E.loading=!1},M=e.ref(!0),I=e.ref(!1),U=e.ref(!1),J=()=>{var e,o;const r=(null==(e=q.value)?void 0:e.data)||{},{cargoes:s,receiver_contact:i,sender_contact:t}=r;return(null==t?void 0:t.name)?(null==i?void 0:i.name)?(null==(o=q.value)?void 0:o.locker_id)?(null==s?void 0:s.length)?M.value?void(I.value=!0):d.toast("请先同意服务协议"):d.toast("请完善物品信息"):d.toast("请扫码选择机柜"):d.toast("请完善收件人信息"):d.toast("请完善寄件人信息")},S=()=>{U.value=!0},D=e.ref();return(o,r)=>e.e({a:e.p({data:e.unref(q)}),b:e.p({data:e.unref(q),location:e.unref(x)}),c:e.o(S),d:e.p({data:e.unref(q).data}),e:!e.unref(M)},e.unref(M)?{f:e.unref(v.config).fileBaseUrl+"/jd/check-true.png"}:{},{g:e.o((o=>M.value=!e.unref(M))),h:e.o((o=>e.unref(l.navigateTo)("/sub-pages/order/agreement/index?from=jd"))),i:e.t(e.unref(E).total_paid?e.unref(m.useToYuan)(e.unref(E).total_paid):"-"),j:e.t(e.unref(E).delivery_promise_time_desc?`估计 ${e.unref(E).delivery_promise_time_desc} 送达`:""),k:e.o(J),l:e.p({isBlock:!0,disabled:!e.unref(y)}),m:e.sr(D,"52f6b680-4",{k:"ModalRef"}),n:e.p({id:"ModalRef"}),o:e.o(C),p:e.o((o=>e.unref(E).loading=o)),q:e.o((o=>e.isRef(I)?I.value=o:null)),r:e.p({data:e.unref(q),location:e.unref(x),"order-data":e.unref(E),loading:e.unref(E).loading,visible:e.unref(I)}),s:e.o(w),t:e.o((o=>e.isRef(U)?U.value=o:null)),v:e.p({data:e.unref(q),visible:e.unref(U)})})}}),E=e._export_sfc(g,[["__scopeId","data-v-52f6b680"]]);wx.createPage(E);
