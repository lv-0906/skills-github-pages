"use strict";const e=require("../../../common/vendor.js"),r=require("../../../local/index.js");require("../../../hooks/uni-hooks/new-dialog.js"),require("../../../store/modules/app.js");const t=require("../../../store/modules/device.js");require("../../../store/modules/order.js");const o=require("../../../store/modules/user.js"),s=require("../../../const/emit.js");require("../../../utils/uniAsync.js"),require("../../../utils/wx.log.js");const i=require("../../../utils/config/index.js"),a=require("../../../hooks/uni-hooks/dialog.js");require("../../../hooks/uni-hooks/request.js");const n=require("../../../hooks/uni-hooks/router.js"),u=require("../../../hooks/uni-hooks/unite.js"),c=require("../../../hooks/uni-hooks/wechat.js"),f=require("../../../hooks/useUpload.js"),l=require("../../../hooks/useCountDown.js"),d=require("../../../hooks/useWechatSI.js"),m=require("../../../api/user.js");require("../../../hooks/useCountryCode.js");const p=require("./hook.js");if(require("../../../shared/cache.js"),require("../../../const/cache.js"),require("../../../hooks/uni-hooks/cache.js"),require("../../../utils/config/env.js"),require("../../../const/platform.js"),require("../../../uni_modules/mot-utils/index.js"),require("../../../theme/hooks/useTheme.js"),require("../../../theme/hooks/themeConfig.js"),require("../../../theme/hooks/themeKeys.js"),require("../../../api/device.js"),require("../../../api/order.js"),require("../../../const/order.js"),require("../../../hooks/usePromise.js"),require("../../../api/delivery.js"),require("../../../shared/device.js"),require("../../../const/common.js"),require("../../../utils/appEnterVerif.js"),require("../../../hooks/use-common.js"),require("../../../hooks/uni-hooks/loading.js"),require("../../../hooks/uni-hooks/common.js"),require("../../../utils/url.js"),require("../../../hooks/uni-hooks/report.js"),require("../../../api/data.js"),!Array){(e.resolveComponent("mot-button")+e.resolveComponent("mot-modal"))()}Math||((()=>"../../../uni_modules/mot-button/components/mot-button/mot-button.js")+(()=>"../../../uni_modules/mot-modal/components/mot-modal/mot-modal.js"))();const h=e.defineComponent({__name:"index",setup(h){const{autoPlay:q}=d.useWechatSI(),j=o.useUserStore(),v=t.useDeviceStore(),{count:k,stop:g,start:_}=l.useCountDown(30);e.ref(!0);const U=e.reactive({avatarUrl:"",loading:!1,step:0,btnText:r.t("face.button.step0"),face:{faceUrl:"",faceId:""},refresh:!0});e.ref();const I={1:r.t("face.step1"),2:r.t("face.step2"),3:r.t("face.step3")};e.watch((()=>U.step),(e=>{2===e&&(E=setInterval((()=>{P.value--,0===P.value&&M(1)}),1e3));const r=I[e];r&&q(r)}));const x=e.ref("face"),{postParams:S,onIdentify:w}=p.useIdentify();e.onLoad((e=>{q(r.t("face.step4"));const{name:t,id_card:o,from:s}=e||{};S.value={name:t,id_card:o},"identify"===s&&(x.value=s,S.value={name:t,id_card:o})}));const y=()=>{C()},C=()=>{e.index.getSetting({success(t){t.authSetting["scope.camera"]?B():e.index.authorize({scope:"scope.camera",success(){b()},fail(){e.index.showModal({title:r.t("me.profile.toast.fail"),content:r.t("face.authorize.camera"),success(r){r.confirm&&e.index.openSetting({success(e){e.authSetting["scope.camera"]&&b()}})}})}})}})},b=()=>{U.refresh=!1;const e=setTimeout((()=>{U.refresh=!0,clearTimeout(e)}),0);a.toast(r.t("me.profile.toast.success"))};e.onShow((()=>{u.unite.setNavigationBarTitle(r.t("face.title"))}));const P=e.ref(2);let E=1;const B=async()=>{if(2!==U.step)try{$(!0),_(),U.step=1;let e="";if(e=await u.unite.takePhoto("facecamera"),console.log("tempImagePathtempImagePathtempImagePath",e),"identify"===x.value){return void(await w(e)?M(2):A())}const r=await f.useUploadImage(e,"locker_face"),t=await m.userApi.faceId({cabinet_id:v.cabinet.id,face_url:r});if(!t)return void A();U.avatarUrl=e,D(r,t)}catch(e){console.log(e),A(),c.envEvent.report.error(`takePhoto.授权失败：${e}`)}else M(1)},A=()=>{U.step=3,g(),$(),T()},T=()=>{U.avatarUrl=""},D=(e,r)=>{U.step=2,U.face={faceUrl:e,faceId:r},g(),$()},M=r=>{clearInterval(E),n.navigateBack({delta:r}).then((()=>{if("identify"===x.value)return void e.index.$emit(s.EMIT_ID_CARD_SUCCESS,!0);const{faceUrl:r,faceId:t}=U.face;j.setOrderOpt({face_url:r,face_id:t}),e.index.$emit(s.EMIT_FACE_UPLOAD_SUCCESS,{faceUrl:r,faceId:t})}))},$=(e=!1)=>{U.loading=e},z=e=>{c.envEvent.report.error(`cameraError.人脸拍照失败：${e}`)},O=e.ref();return(t,o)=>{return e.e({a:e.unref(U).refresh},e.unref(U).refresh?e.e({b:e.unref(U).avatarUrl},e.unref(U).avatarUrl?{c:e.unref(U).avatarUrl}:{d:e.o(z)}):{},{e:1===e.unref(U).step},1===e.unref(U).step?{f:e.t(e.unref(r.t)("face.step1")),g:e.t(e.unref(k))}:2===e.unref(U).step?{i:e.unref(i.config).fileBaseUrl+"/icon/icon_success.png",j:e.t(e.unref(r.t)("face.step2"))}:3===e.unref(U).step?{l:e.unref(i.config).fileBaseUrl+"/icon/icon_error.png",m:e.t(e.unref(r.t)("face.step3"))}:{n:e.t(e.unref(r.t)("face.step0"))},{h:2===e.unref(U).step,k:3===e.unref(U).step,o:e.t(e.unref(r.t)("face.requirement.title")),p:e.unref(i.config).fileBaseUrl+"/face_light_success.png",q:e.t(e.unref(r.t)("face.requirement.condition1")),r:e.unref(i.config).fileBaseUrl+"/face_error.png",s:e.t(e.unref(r.t)("face.requirement.condition2")),t:e.unref(i.config).fileBaseUrl+"/face_success.png",v:e.t(e.unref(r.t)("face.requirement.condition3")),w:e.t((s=e.unref(U).step,r.t(`face.button.step${s}`)+""+(2===s?"（"+P.value+"s）":""))),x:e.o(y),y:e.p({shape:"square",isBlock:!0}),z:e.sr(O,"baf238c9-1",{k:"ModalRef"}),A:e.p({id:"ModalRef"})});var s}}}),q=e._export_sfc(h,[["__scopeId","data-v-baf238c9"]]);wx.createPage(q);
